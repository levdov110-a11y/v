<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="icon" type="image/png" href="1.JPG">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מערכת ניהול - עזר חתנים | גרסה מלאה ומשודרגת</title>
    
    <!-- ספריות חיצוניות -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- JSPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- קישור לקובץ העיצוב החיצוני -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="h-full text-slate-800 bg-main overflow-hidden">

    <!-- מכל התראות -->
    <div id="toast-container"></div>
    
    <!-- מחוון חיבור -->
    <div id="connection-status" class="status-offline" onclick="this.classList.toggle('status-collapsed')" title="לחץ לכיווץ/הרחבה">
        <i class="fas fa-wifi"></i> <span id="conn-text" class="mr-2">טוען...</span>
    </div>

    <!-- אלמנטים נסתרים ליבוא -->
    <input type="file" id="excel-upload-input" accept=".xlsx, .xls" class="hidden" onchange="Importer.handleFileSelect(this)">
    <input type="file" id="json-import-input" accept=".json" class="hidden" onchange="Settings.importDataFromJSON(this)">

    <!-- אזור הדפסה -->
    <div id="print-area"></div>

    <!-- עורך דוחות -->
    <div id="report-editor-screen" class="hidden-screen">
        <aside id="report-sidebar">
            <div class="flex justify-between items-center border-b pb-2">
                <h2 class="text-xl font-bold">עורך דוח תצוגה</h2>
                <button onclick="Reports.closeEditor()" class="text-red-500 hover:bg-red-50 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4 overflow-y-auto custom-scroll flex-1">
                <div>
                    <label class="text-sm font-bold block mb-1">כותרת הדוח</label>
                    <input type="text" id="editor-title-input" value="דוח תצוגה משוקלל" class="input-field w-full text-sm" oninput="Reports.updateTitle(this.value)">
                </div>
                
                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-1">שורות לדף (פריטים)</label>
                    <input type="number" value="22" onchange="Reports.setRowsPerPage(this.value)" class="input-field w-full text-sm">
                </div>

                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-2">תמונת רקע</label>
                    <input type="file" id="editor-bg-input" accept="image/*" class="text-xs mb-2" onchange="Reports.updateBackground(this)">
                    <div class="flex items-center gap-2">
                        <span class="text-xs">שקיפות:</span>
                        <input type="range" min="0" max="1" step="0.1" value="0.2" oninput="Reports.updateBgOpacity(this.value)" class="flex-1">
                    </div>
                </div>

                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-2">כיוון דף</label>
                    <select onchange="Reports.setOrientation(this.value)" class="input-field w-full text-sm">
                        <option value="landscape">לרוחב (Landscape)</option>
                        <option value="portrait">לאורך (Portrait)</option>
                    </select>
                </div>

                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-2">אלמנטים נוספים</label>
                    <button onclick="document.getElementById('editor-add-img').click()" class="w-full bg-indigo-50 text-indigo-700 py-2 rounded font-bold text-sm border border-indigo-200 hover:bg-indigo-100 mb-2">
                        <i class="fas fa-image ml-1"></i> הוסף תמונה
                    </button>
                    <input type="file" id="editor-add-img" accept="image/*" class="hidden" onchange="Reports.addDecorImage(this)">
                    <p class="text-[10px] text-gray-500">ניתן לגרור ולשנות גודל. יופיע בהדפסה.</p>
                </div>
                
                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-1">זום תצוגה</label>
                    <input type="range" min="0.3" max="1.5" step="0.1" value="0.6" oninput="Reports.setZoom(this.value)" class="w-full">
                </div>

                <div class="border-t pt-2">
                    <label class="text-sm font-bold block mb-2">עריכת כותרות וסדר (לחץ לשינוי)</label>
                    <div id="editor-headers-container" class="space-y-1"></div>
                </div>
            </div>

            <div class="border-t pt-4 mt-auto gap-2 flex flex-col">
                <button onclick="Reports.printEditor()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700">
                    <i class="fas fa-print ml-2"></i> הדפס דוח (רב עמודים)
                </button>
                <button onclick="Reports.closeEditor()" class="w-full bg-gray-100 text-gray-700 py-2 rounded-xl font-bold hover:bg-gray-200">
                    סגור
                </button>
            </div>
        </aside>
        
        <div id="report-canvas-container"></div>
    </div>

    <!-- טיימר התנתקות -->
    <div id="timeout-modal" class="fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center hidden-screen backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md border-t-8 border-red-500 animate-bounce-slight">
            <div class="text-6xl text-red-500 mb-4"><i class="fas fa-hourglass-half"></i></div>
            <h2 class="text-2xl font-bold mb-2">זיהינו חוסר פעילות</h2>
            <p class="text-gray-600 mb-6">המערכת תתנתק באופן אוטומטי בעוד <span id="timeout-countdown" class="font-bold text-red-600 text-xl">60</span> שניות לצורכי אבטחה.</p>
            <button onclick="InactivityTimer.stayLoggedIn()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">השאר אותי מחובר</button>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div id="celebration-modal" class="fixed inset-0 z-[10000] bg-black/90 flex items-center justify-center hidden-screen">
        <div class="absolute inset-0 overflow-hidden pointer-events-none" id="confetti-container"></div>
        <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-lg border-4 border-amber-400 relative z-10 transform scale-100 transition-transform">
            <div class="w-24 h-24 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i class="fas fa-trophy text-5xl text-amber-500 animate-bounce"></i>
            </div>
            <h2 class="text-4xl font-extrabold text-slate-800 mb-2">כל הכבוד!</h2>
            <h3 class="text-2xl font-bold text-indigo-600 mb-4" id="celebration-name">שם הבחור</h3>
            <p class="text-lg text-gray-600 mb-6">הבחור הגיע ליעד של <span id="celebration-amount" class="font-bold"></span> ש"ח!</p>
            <div class="bg-amber-50 p-4 rounded-xl border border-amber-200 mb-6">
                <div class="text-sm text-amber-800 font-bold uppercase tracking-wider mb-1">המתנה שמגיעה לו:</div>
                <div class="text-2xl font-black text-amber-600" id="celebration-reward">...</div>
            </div>
            <button onclick="document.getElementById('celebration-modal').classList.add('hidden-screen')" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">סגור חלון</button>
        </div>
    </div>

    <!-- מסך טעינה -->
    <div id="loader" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col justify-center items-center transition-opacity duration-500">
        <div id="loader-spinner" class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 mb-4"></div>
        <h2 id="loader-text" class="text-white text-xl font-medium tracking-wide">טוען נתונים...</h2>
    </div>

    <!-- מסך התחברות -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex flex-col justify-center items-center hidden-screen bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        <div class="bg-white/95 backdrop-blur p-10 rounded-3xl shadow-2xl w-96 text-center border border-white/20">
            <img src="1.JPG" alt="לוגו מערכת" class="logo-img-login" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
            <div class="hidden text-indigo-700 text-6xl mb-6"><i class="fas fa-synagogue"></i></div>
            
            <h1 class="text-2xl font-bold text-slate-800 mb-1">ברוכים הבאים</h1>
            <p class="text-gray-500 mb-8 text-sm">ניהול מערכת - עזר חתנים</p>
            
            <form onsubmit="Auth.login(event)" class="space-y-4" autocomplete="off">
                <div class="relative">
                    <i class="fas fa-envelope absolute top-3.5 right-3 text-gray-400"></i>
                    <input style="display:none" type="text" name="fakeusernameremembered"/>
                    <input style="display:none" type="password" name="fakepasswordremembered"/>
                    
                    <input type="email" id="email" placeholder="אימייל" autocomplete="off" class="w-full bg-slate-50 border border-slate-200 p-3 pr-10 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute top-3.5 right-3 text-gray-400"></i>
                    <input type="password" id="password" placeholder="סיסמה" autocomplete="new-password" class="w-full bg-slate-50 border border-slate-200 p-3 pr-10 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold transition shadow-lg transform active:scale-95">כניסה למערכת</button>
            </form>
            <div id="login-msg" class="text-red-500 text-sm mt-4 hidden font-bold bg-red-50 p-2 rounded"></div>
        </div>
    </div>

    <!-- ממשק האפליקציה -->
    <div class="flex h-full w-full relative overflow-hidden">

        <!-- תפריט צד -->
        <aside id="sidebar" class="w-64 bg-sidebar text-slate-300 flex flex-col hidden-screen shadow-2xl z-20 h-full border-l border-slate-700 shrink-0">
            <div class="p-6 border-b border-slate-700/50 flex items-center justify-center h-32 bg-black/20">
                <img src="1.JPG" alt="לוגו" class="logo-img-sidebar hover:scale-105 transition" onerror="this.outerHTML='<h2 class=\'font-bold text-xl text-white\'>עזר חתנים</h2>'">
            </div>

            <nav class="flex-1 overflow-y-auto py-6 space-y-1 custom-scroll">
                <button onclick="Router.go('dashboard')" id="nav-dashboard" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-chart-pie w-5 text-center text-indigo-400"></i> לוח מחוונים
                </button>
                
                <div class="px-6 py-3 text-xs font-bold text-slate-500 uppercase mt-2 tracking-wider">ניהול נתונים</div>
                <button onclick="Router.go('students')" id="nav-students" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-user-graduate w-5 text-center text-blue-400"></i> בחורים
                </button>
                <button onclick="Router.go('donors')" id="nav-donors" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-hand-holding-usd w-5 text-center text-emerald-400"></i> תורמים
                </button>
                <button onclick="Router.go('groups')" id="nav-groups" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-users-cog w-5 text-center text-amber-400"></i> קבוצות ומסלולים
                </button>

                <div class="px-6 py-3 text-xs font-bold text-slate-500 uppercase mt-2 tracking-wider">כספים ודוחות</div>
                <button onclick="Router.go('finance')" id="nav-finance" class="nav-btn financial-data w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-cash-register w-5 text-center text-rose-400"></i> ניהול קופה
                </button>
                <button onclick="Router.go('reports')" id="nav-reports" class="nav-btn w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-file-excel w-5 text-center text-green-400"></i> דוחות והדפסות
                </button>
                
                <div class="px-6 py-3 text-xs font-bold text-slate-500 uppercase mt-2 tracking-wider admin-only">מנהל</div>
                <button onclick="Router.go('settings')" id="nav-settings" class="nav-btn admin-only w-full text-right px-6 py-3.5 hover:bg-white/5 transition flex items-center gap-4 border-r-4 border-transparent text-sm font-medium">
                    <i class="fas fa-sliders-h w-5 text-center text-gray-400"></i> הגדרות מערכת
                </button>
            </nav>

            <div class="mt-auto bg-slate-900/50 backdrop-blur-md border-t border-slate-700/50 p-4">
                <button onclick="Auth.logout()" class="group w-full flex items-center gap-3 p-2.5 rounded-xl hover:bg-red-500/10 hover:text-red-400 transition-all duration-300 mb-4 border border-transparent hover:border-red-500/20">
                    <div class="bg-slate-800 group-hover:bg-red-50 text-slate-400 group-hover:text-white w-8 h-8 rounded-lg flex items-center justify-center transition-colors shadow-lg">
                        <i class="fas fa-power-off text-xs"></i>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-slate-300 group-hover:text-red-300">התנתק מהמערכת</div>
                        <div id="user-email-display" class="text-[10px] text-slate-500 truncate w-32">user@sys</div>
                    </div>
                </button>

                <div class="relative overflow-hidden rounded-xl bg-gradient-to-r from-indigo-900/40 to-slate-900/40 border border-slate-700/50 p-3 text-center group">
                    <div class="absolute inset-0 bg-indigo-500/5 opacity-0 group-hover:opacity-100 transition duration-500"></div>
                    <p class="text-[10px] text-slate-400 font-medium tracking-wide mb-1 relative z-10">פותח ועוצב ע״י</p>
                    <h4 class="text-sm font-bold text-indigo-300 relative z-10 group-hover:text-white transition-colors">דובי לוי</h4>
                    <a href="mailto:7640421@gmail.com" class="text-[10px] text-slate-500 hover:text-indigo-400 transition relative z-10 flex items-center justify-center gap-1 mt-1">
                        <i class="fas fa-envelope"></i> 7640421@gmail.com
                    </a>
                </div>
            </div>
        </aside>

        <!-- תוכן ראשי -->
        <main id="main-content" class="flex-1 flex flex-col hidden-screen h-full overflow-hidden relative bg-slate-50">
            
            <header class="bg-white shadow-sm h-16 flex justify-between items-center px-8 z-10 shrink-0 border-b border-gray-200">
                <div class="flex items-center gap-4">
                    <button onclick="document.getElementById('sidebar').classList.toggle('hidden-screen')" class="lg:hidden p-2 text-gray-600"><i class="fas fa-bars"></i></button>
                    <h2 id="page-title" class="text-2xl font-bold text-slate-800 tracking-tight">דף הבית</h2>
                </div>
                
                <div class="flex items-center gap-2">
                     <button onclick="System.refreshModule()" class="text-gray-500 hover:text-indigo-600 p-2" title="רענן מודול נוכחי"><i class="fas fa-sync-alt"></i></button>
                     <button onclick="history.back()" class="text-gray-500 hover:text-indigo-600 p-2" title="חזור"><i class="fas fa-arrow-left"></i></button>
                    <div class="bg-indigo-50 px-3 py-1 rounded-lg border border-indigo-100 flex items-center gap-2">
                        <span class="text-sm text-indigo-900 font-bold">שנה נוכחית:</span>
                        <select id="year-selector" onchange="System.changeYear(this.value)" class="bg-transparent border-none text-indigo-700 font-bold text-sm focus:ring-0 cursor-pointer py-0 outline-none">
                        </select>
                        <button onclick="System.addCustomYear()" class="text-indigo-600 hover:text-indigo-800 text-xs bg-white border border-indigo-200 rounded px-1 ml-1 admin-only" title="הוסף שנה ידנית"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </header>

            <div id="views-container" class="flex-1 overflow-hidden relative">
                
                <!-- 1. DASHBOARD -->
                <div id="view-dashboard" class="view-section p-6 fade-in hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 financial-data">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md transition">
                            <div>
                                <div class="text-slate-500 text-sm font-medium mb-1">יתרה בקופה (כללי)</div>
                                <div class="text-3xl font-bold text-slate-800" id="dash-total-balance">...</div>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center text-xl"><i class="fas fa-wallet"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md transition">
                            <div>
                                <div class="text-slate-500 text-sm font-medium mb-1">הכנסות (<span class="curr-year"></span>)</div>
                                <div class="text-3xl font-bold text-emerald-600" id="dash-income">...</div>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-xl"><i class="fas fa-arrow-down"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between hover:shadow-md transition">
                            <div>
                                <div class="text-slate-500 text-sm font-medium mb-1">הוצאות (<span class="curr-year"></span>)</div>
                                <div class="text-3xl font-bold text-rose-600" id="dash-expense">...</div>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-rose-50 text-rose-600 flex items-center justify-center text-xl"><i class="fas fa-arrow-up"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-2">
                                <div class="text-slate-500 text-sm font-medium">יעד שנתי: <span id="dash-goal-text-amount" class="text-amber-700 font-bold ml-1"></span></div>
                                <div class="text-amber-600 font-bold" id="dash-goal-progress">0%</div>
                            </div>
                            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                <div id="dash-bar" class="bg-amber-500 h-full rounded-full transition-all duration-1000" style="width:0%"></div>
                            </div>
                            <div class="mt-2 text-xs text-slate-400">הנתונים מתעדכנים בזמן אמת</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-96">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col overflow-hidden">
                            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700"><i class="fas fa-history text-indigo-500 ml-2"></i>עדכונים אחרונים</h3>
                                <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full">לייב</span>
                            </div>
                            <div id="dash-logs" class="p-4 overflow-y-auto flex-1 custom-scroll">
                                <p class="text-center text-gray-400 mt-4">טוען תנועות אחרונות...</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6">
                            <div class="bg-gradient-to-br from-indigo-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white flex flex-col items-center justify-center relative overflow-hidden">
                                <i class="fas fa-user-graduate absolute -bottom-4 -right-4 text-8xl text-white/10"></i>
                                <div class="text-5xl font-bold mb-2 z-10" id="dash-stat-students">...</div>
                                <div class="text-indigo-100 z-10">בחורים רשומים</div>
                            </div>
                            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg p-6 text-white flex flex-col items-center justify-center relative overflow-hidden">
                                <i class="fas fa-hand-holding-heart absolute -bottom-4 -right-4 text-8xl text-white/10"></i>
                                <div class="text-5xl font-bold mb-2 z-10" id="dash-stat-donors">...</div>
                                <div class="text-emerald-100 z-10">תורמים במערכת</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. STUDENTS -->
                <div id="view-students" class="view-section flex flex-col hidden fade-in bg-white h-full overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex gap-3 items-center justify-between shrink-0">
                        <div class="flex gap-3">
                            <button onclick="Students.openAddModal()" class="btn-primary bg-indigo-600"><i class="fas fa-plus ml-2"></i> הוסף בחור</button>
                            <button onclick="Students.openQuickAdd()" class="btn-secondary"><i class="fas fa-layer-group ml-2 text-indigo-500"></i> הוספה מהירה</button>
                            <button onclick="Importer.init('students')" class="btn-secondary"><i class="fas fa-file-excel ml-2 text-green-600"></i> יבוא מאקסל</button>
                        </div>
                        <div class="relative w-96">
                            <input type="text" id="student-search" oninput="System.searchFirebase(this.value, 'students')" placeholder="חיפוש לפי שם, שיעור או טלפון..." class="input-field w-full pl-4 pr-10">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 custom-scroll" id="students-container">
                        <div class="overflow-x-auto w-full">
                            <table class="w-full text-sm min-w-[600px]">
                                <thead class="bg-slate-50 text-slate-600 sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="p-3 text-right rounded-r-lg bg-slate-50">שם מלא</th>
                                        <th class="p-3 text-right bg-slate-50">שיעור</th>
                                        <th class="p-3 text-right bg-slate-50">שנת כניסה</th>
                                        <th class="p-3 text-right bg-slate-50">יעד אישי (<span class="curr-year"></span>)</th>
                                        <th class="p-3 text-center rounded-l-lg bg-slate-50">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="students-tbody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <div id="students-loader-more" class="p-6 text-center mt-2 hidden">
                            <button onclick="Students.loadMore()" class="bg-slate-100 text-slate-600 hover:bg-slate-200 px-6 py-2 rounded-full text-sm font-bold transition shadow-sm">
                                <i class="fas fa-chevron-down ml-2"></i> טען עוד בחורים
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. DONORS -->
                <div id="view-donors" class="view-section flex flex-col hidden fade-in h-full overflow-hidden">
                    <div class="p-4 bg-white rounded-t-2xl shadow-sm border-b flex flex-col gap-4 mb-0 shrink-0">
                         <div class="flex justify-between items-center w-full">
                            <div class="flex gap-3">
                                <button onclick="Donors.openAddModal()" class="btn-primary bg-emerald-600"><i class="fas fa-plus ml-2"></i> הוסף תורם</button>
                                <button onclick="Donors.toggleQuickManager()" class="btn-secondary border-emerald-200 text-emerald-700 bg-emerald-50 hover:bg-emerald-100">
                                    <i class="fas fa-th ml-2"></i> ניהול שיבוץ מהיר לקבוצות
                                </button>
                                <button onclick="Importer.init('donors')" class="btn-secondary"><i class="fas fa-file-excel text-green-600"></i> יבוא מאקסל</button>
                            </div>
                            <div class="relative w-80">
                                <input type="text" id="donor-search-input" oninput="Donors.renderList(this.value)" placeholder="חפש תורם..." class="input-field w-full pl-4 pr-10">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="flex gap-2 justify-center border-t pt-3 flex-wrap">
                             <button onclick="Donors.setViewTab('all')" class="tab-modern donor-view-tab active" data-tab="all">כל התורמים</button>
                             <button onclick="Donors.setViewTab('unassigned')" class="tab-modern donor-view-tab" data-tab="unassigned">לא משובצים</button>
                             <button onclick="Donors.setViewTab('night14')" class="tab-modern donor-view-tab" data-tab="night14">ליל י"ד</button>
                             <button onclick="Donors.setViewTab('day14')" class="tab-modern donor-view-tab" data-tab="day14">יום י"ד</button>
                             <button onclick="Donors.setViewTab('day15')" class="tab-modern donor-view-tab" data-tab="day15">יום ט"ו</button>
                        </div>
                        <div id="donors-groups-filter" class="hidden flex justify-center gap-2 mt-2 bg-gray-50 p-2 rounded">
                            <span class="text-sm font-bold text-gray-500 self-center">סנן לפי קבוצה:</span>
                            <select id="donor-group-select" onchange="Donors.renderList()" class="border p-1 rounded text-sm min-w-[150px]">
                                <option value="">הכל</option>
                            </select>
                        </div>
                    </div>

                    <div id="donors-list-view" class="flex-1 overflow-y-auto p-4 custom-scroll">
                        <div class="overflow-x-auto w-full">
                            <table class="w-full text-sm min-w-[600px]">
                                <thead class="bg-slate-50 text-slate-600 sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="p-3 text-right rounded-r-lg bg-slate-50">שם מלא</th>
                                        <th class="p-3 text-right bg-slate-50">כתובת</th>
                                        <th class="p-3 text-right bg-slate-50">טלפון</th>
                                        <th class="p-3 text-right bg-slate-50">קבוצה</th>
                                        <th class="p-3 text-center rounded-l-lg bg-slate-50">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="donors-tbody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <div id="donors-loader-more" class="p-4 text-center hidden">
                            <button onclick="Donors.loadMore()" class="bg-slate-200 text-slate-600 px-6 py-2 rounded-full font-bold text-sm">טען עוד...</button>
                        </div>
                    </div>

                    <div id="donors-quick-manager" class="hidden flex-1 flex flex-col h-full overflow-hidden bg-white">
                         <div class="p-3 border-b bg-slate-50 flex gap-2 shrink-0 justify-center">
                            <button onclick="Donors.setKanbanDay('night14')" class="tab-modern kanban-tab active" data-day="night14">ליל י"ד</button>
                            <button onclick="Donors.setKanbanDay('day14')" class="tab-modern kanban-tab" data-day="day14">יום י"ד</button>
                            <button onclick="Donors.setKanbanDay('day15')" class="tab-modern kanban-tab" data-day="day15">יום ט"ו</button>
                        </div>
                        
                        <div class="flex-1 flex gap-4 overflow-hidden p-4">
                            <div class="w-1/4 bg-white rounded-xl shadow border flex flex-col h-full shrink-0">
                                <div class="p-3 border-b bg-gray-50 font-bold text-gray-700 flex justify-between">
                                    <span>מאגר לא משובצים</span>
                                    <span id="pool-count" class="bg-gray-200 text-xs px-2 py-0.5 rounded-full">0</span>
                                </div>
                                <div class="p-2 border-b"><input type="text" placeholder="סנן..." oninput="Donors.filterPool(this.value)" class="w-full text-xs p-1 border rounded"></div>
                                <div id="donor-pool-list" class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50/50 custom-scroll"></div>
                            </div>

                            <div class="flex-1 bg-white rounded-xl shadow border flex flex-col overflow-hidden">
                                <div class="p-3 border-b bg-indigo-50 font-bold text-indigo-800 flex justify-between items-center">
                                    <span>קבוצות השנה (<span class="curr-year"></span>)</span>
                                    <div class="text-xs font-normal">לחץ על כותרת קבוצה לצפייה בפרטים</div>
                                </div>
                                <div class="flex-1 overflow-x-auto overflow-y-hidden p-4 whitespace-nowrap bg-slate-100 custom-scroll" id="groups-kanban-container">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. GROUPS -->
                <div id="view-groups" class="view-section flex flex-col hidden fade-in bg-white h-full overflow-hidden">
                    <div class="px-6 py-4 border-b bg-slate-50 flex gap-3 shrink-0 justify-center shadow-sm z-10 items-center">
                        <button onclick="Groups.setDay('night14')" class="tab-modern group-tab active" data-day="night14">ליל י"ד</button>
                        <button onclick="Groups.setDay('day14')" class="tab-modern group-tab" data-day="day14">יום י"ד</button>
                        <button onclick="Groups.setDay('day15')" class="tab-modern group-tab" data-day="day15">יום ט"ו</button>
                        <div class="h-8 w-px bg-gray-300 mx-2"></div>
                        <button onclick="Groups.printAllGroups()" class="bg-gray-800 text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-gray-700"><i class="fas fa-print ml-1"></i> הדפס משבצות (יום נבחר)</button>
                    </div>

                    <div class="flex flex-1 overflow-hidden">
                        <div class="w-72 border-l flex flex-col bg-white">
                            <div class="p-4 border-b flex justify-between items-center bg-gray-50/50">
                                <span class="font-bold text-sm text-slate-700">רשימת קבוצות</span>
                                <button onclick="Groups.addNewGroup()" class="bg-indigo-100 text-indigo-600 hover:bg-indigo-200 p-1.5 rounded-lg transition"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="groups-list" class="flex-1 overflow-y-auto custom-scroll"></div>
                        </div>

                        <div class="flex-1 flex flex-col bg-slate-50 relative" id="group-workspace">
                            <div id="group-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400 flex-col">
                                <i class="fas fa-layer-group text-6xl mb-4 text-slate-200"></i>
                                <p>בחר קבוצה לעריכה</p>
                            </div>

                            <div id="group-editor" class="hidden flex flex-col h-full">
                                <div class="bg-white p-4 border-b flex justify-between items-center shadow-sm z-10">
                                    <div class="flex gap-3 items-center">
                                        <h3 id="active-group-name" class="font-bold text-xl text-slate-800 cursor-pointer hover:bg-gray-100 px-2 rounded" onclick="Groups.renameGroup()" title="לחץ לשינוי שם"></h3>
                                        <span id="active-group-details" class="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded-full border"></span>
                                        <button onclick="Groups.deleteGroup()" class="text-red-500 bg-red-50 hover:bg-red-100 px-2 py-1 rounded border border-red-100 text-xs font-bold mr-2">מחק קבוצה</button>
                                        <button onclick="Groups.openGroupDonationModal()" class="btn-secondary text-xs bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 font-bold"><i class="fas fa-hand-holding-usd"></i> תרומה קבוצתית</button>
                                    </div>
                                    <div class="flex gap-2 text-sm">
                                        <button onclick="Groups.printSheet('members')" class="btn-secondary text-xs"><i class="fas fa-users"></i> דף קבוצה</button>
                                        <button onclick="Groups.printSheet('route')" class="btn-secondary text-xs"><i class="fas fa-route"></i> דף מסלול</button>
                                        <button onclick="Groups.exportGroupData('excel')" class="btn-secondary text-xs admin-only"><i class="fas fa-file-excel"></i> יצוא אקסל</button>
                                        <button onclick="Groups.exportGroupData('pdf')" class="btn-secondary text-xs admin-only"><i class="fas fa-file-pdf"></i> יצוא PDF</button>
                                    </div>
                                </div>

                                <div class="flex flex-1 overflow-hidden">
                                    <div class="w-1/2 flex flex-col border-l bg-white">
                                        <div class="p-3 bg-emerald-50 text-emerald-900 font-bold text-sm border-b flex justify-between">
                                            <span><i class="fas fa-map-signs"></i> מסלול תורמים</span>
                                            <span class="text-xs font-normal opacity-70">סדר את המסלול בגרירה</span>
                                        </div>
                                        <div id="group-route-list" class="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50/50 custom-scroll"></div>
                                    </div>

                                    <div class="w-1/2 flex flex-col bg-white">
                                        <div class="p-3 bg-indigo-50 text-indigo-900 font-bold text-sm border-b"><i class="fas fa-user-friends"></i> שיבוץ בחורים</div>
                                        <div class="flex-1 flex flex-col overflow-hidden">
                                            <div id="group-members-list" class="flex-1 overflow-y-auto p-3 space-y-2 h-1/2 border-b custom-scroll"></div>
                                            <div class="h-1/2 flex flex-col bg-slate-50">
                                                <div class="p-2 border-b bg-white relative">
                                                    <input type="text" placeholder="חפש בחור להוספה..." oninput="Groups.filterStudents(this.value)" class="w-full text-sm p-2 border rounded pl-8">
                                                    <i class="fas fa-search absolute left-4 top-4 text-gray-300 text-xs"></i>
                                                </div>
                                                <div id="pool-students" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. FINANCE -->
                <div id="view-finance" class="view-section flex flex-col hidden fade-in financial-data bg-white h-full overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-slate-50 shrink-0">
                        <div class="flex gap-3">
                             <button onclick="Finance.renderBatchTransactionForm()" class="btn-primary bg-indigo-600 hover:bg-indigo-700"><i class="fas fa-plus-circle ml-2"></i> הוסף תנועה / רשימה מרוכזת</button>
                             <button onclick="Finance.openVouchersView()" class="btn-secondary text-purple-700 border-purple-200 bg-purple-50 hover:bg-purple-100 font-bold"><i class="fas fa-ticket-alt ml-2"></i> מימוש תלושים</button>
                             <button onclick="Finance.openStoreDebtsView()" class="btn-secondary text-rose-700 border-rose-200 bg-rose-50 hover:bg-rose-100 font-bold"><i class="fas fa-store-alt ml-2"></i> ניהול חובות לחנויות</button>
                        </div>
                        <div class="flex bg-white rounded-lg p-1 border shadow-sm">
                            <button onclick="Finance.setFilter('all')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter active" data-f="all">הכל</button>
                            <button onclick="Finance.setFilter('income')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter hover:bg-gray-50 text-gray-600" data-f="income">הכנסות</button>
                            <button onclick="Finance.setFilter('expense')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter hover:bg-gray-50 text-gray-600" data-f="expense">הוצאות</button>
                            <button onclick="Finance.setFilter('purim')" class="px-4 py-1.5 rounded-md text-sm font-medium transition finance-filter hover:bg-purple-50 text-purple-600" data-f="purim"><i class="fas fa-mask ml-1"></i> פורים</button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-hidden flex flex-col" id="finance-main-view">
                        <div class="overflow-y-auto flex-1 p-4 custom-scroll" id="finance-scroll-container">
                            <div class="overflow-x-auto w-full">
                                <table class="w-full text-sm text-right border-collapse min-w-[600px]">
                                    <thead class="bg-slate-100 text-slate-600 sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th class="p-3 rounded-r-lg bg-slate-100">תאריך</th>
                                            <th class="p-3 bg-slate-100">סוג</th>
                                            <th class="p-3 bg-slate-100">קטגוריה</th>
                                            <th class="p-3 bg-slate-100">תיאור / משוייך ל...</th>
                                            <th class="p-3 bg-slate-100">סכום</th>
                                            <th class="p-3 rounded-l-lg bg-slate-100">פעולות</th>
                                        </tr>
                                    </thead>
                                    <tbody id="finance-tbody" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                            <div id="finance-loader-more" class="p-4 text-center mt-2 hidden">
                                <button onclick="Finance.loadMore()" class="text-indigo-600 hover:underline font-bold">טען היסטוריה ישנה יותר...</button>
                            </div>
                        </div>
                    </div>
                    <!-- אזור מימוש תלושים -->
                    <div id="finance-vouchers-view" class="hidden flex-1 overflow-y-auto p-4 custom-scroll bg-purple-50">
                        <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow">
                            <h3 class="font-bold text-xl mb-4 text-purple-800 flex justify-between">
                                <span><i class="fas fa-ticket-alt ml-2"></i> תלושים שממתינים למימוש (עדיין לא הוצאה)</span>
                                <button onclick="Finance.closeVouchersView()" class="text-sm bg-gray-200 px-3 py-1 rounded">חזור לקופה</button>
                            </h3>
                            <div id="pending-vouchers-list" class="space-y-2"></div>
                        </div>
                    </div>
                    <!-- אזור חובות לחנויות -->
                    <div id="finance-store-debts-view" class="hidden flex-1 overflow-y-auto p-4 custom-scroll bg-rose-50">
                         <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow">
                            <h3 class="font-bold text-xl mb-4 text-rose-800 flex justify-between">
                                <span><i class="fas fa-store-alt ml-2"></i> ניהול חובות לחנויות (תלושים שמומשו)</span>
                                <button onclick="Finance.closeStoreDebtsView()" class="text-sm bg-gray-200 px-3 py-1 rounded">חזור לקופה</button>
                            </h3>
                            <div id="store-debts-container"></div>
                        </div>
                    </div>
                </div>

                <!-- 6. REPORTS -->
                <div id="view-reports" class="view-section hidden fade-in p-6">
                    <h2 class="text-3xl font-bold mb-8 text-slate-800">דוחות והדפסות</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        
                        <!-- דוח כספי - מוסתר למשתמש רגיל -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition admin-only">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center mb-4"><i class="fas fa-file-invoice-dollar text-xl"></i></div>
                            <h3 class="font-bold text-lg mb-2">דוח תנועות כספיות</h3>
                            <p class="text-sm text-gray-500 mb-4">ייצוא כל ההכנסות וההוצאות לאקסל עם אפשרויות סינון.</p>
                            <div class="space-y-3">
                                <select id="rep-type" class="input-field w-full text-sm"><option value="all">הכל</option><option value="income">רק הכנסות</option><option value="expense">רק הוצאות</option></select>
                                <div class="relative group">
                                    <input type="text" id="rep-entity-search" placeholder="חפש בחור/תורם לסינון..." oninput="Reports.searchEntity(this.value)" class="input-field w-full text-sm">
                                    <input type="hidden" id="rep-entity-id">
                                    <div id="rep-entity-results" class="absolute top-full right-0 w-full bg-white border shadow-lg rounded-b max-h-40 overflow-y-auto hidden z-20 custom-scroll"></div>
                                </div>
                                <button onclick="Reports.generateStandard()" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold hover:bg-slate-700 text-sm">הורד לאקסל</button>
                            </div>
                        </div>

                        <!-- דוח תצוגה - פתוח לכולם -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition">
                            <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center mb-4"><i class="fas fa-magic text-xl"></i></div>
                            <h3 class="font-bold text-lg mb-2">דוח תצוגה (אחרי פורים)</h3>
                            <p class="text-sm text-gray-500 mb-4">נתונים משוקללים להדפסה (כל הבחורים, בונוסים ועוד) עם עורך חזותי מלא.</p>
                            <button onclick="Reports.openEditor()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-bold hover:bg-purple-700 text-sm">פתח עורך דוחות</button>
                        </div>
                    </div>
                </div>

                <!-- 7. SETTINGS -->
                <div id="view-settings" class="view-section p-6 hidden fade-in admin-only">
                    <div class="max-w-5xl mx-auto space-y-8 pb-10">
                        <h2 class="text-3xl font-bold text-slate-800">הגדרות מערכת</h2>

                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-orange-100 bg-orange-50/30">
                            <div class="flex justify-between items-center gap-4">
                                <div>
                                    <h3 class="font-bold text-xl text-orange-800">תחזוקה שנתית</h3>
                                    <p class="text-sm text-gray-500">קידום שיעורים וסנכרון לשנה העברית החדשה. בוגרי "קיבוץ ח" יועברו לרשימת תורמים.</p>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button onclick="Settings.syncYears()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition text-sm">בצע סנכרון שנתי</button>
                                    <button onclick="Groups.copyFromPreviousYear()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition text-sm">יבא מבנה קבוצות משנה שעברה</button>
                                    <button onclick="System.clearLocalCache()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition text-sm"><i class="fas fa-eraser ml-1"></i> נקה מטמון דפדפן (פתרון תקלות)</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-8 rounded-2xl shadow-sm border">
                            <h3 class="font-bold text-xl mb-6 text-slate-700 border-b pb-2">ניהול משתמשים והרשאות</h3>
                            <div class="grid grid-cols-1 gap-4">
                                <div class="p-4 bg-gray-50 rounded-xl border">
                                    <h4 class="font-bold mb-3 text-sm">הוסף משתמש / מנהל חדש</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <input type="email" id="new-user-email" placeholder="אימייל" class="input-field text-sm">
                                        <input type="password" id="new-user-pass" placeholder="סיסמה" class="input-field text-sm">
                                        <select id="new-user-role" class="input-field text-sm">
                                            <option value="user">משתמש (עריכה בלבד, ללא כספים)</option>
                                            <option value="admin">מנהל (הרשאה מלאה)</option>
                                        </select>
                                        <button onclick="Settings.createUser()" class="bg-slate-800 text-white rounded-lg font-bold text-sm">צור משתמש</button>
                                    </div>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <h4 class="font-bold mb-3 text-sm">משתמשים קיימים</h4>
                                    <div id="users-list-container" class="space-y-2"></div>
                                    <button onclick="Settings.loadUsersList()" class="text-sm text-blue-600 font-bold hover:underline mt-2">טען רשימת משתמשים</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-indigo-100">
                             <h3 class="font-bold text-xl mb-6 text-indigo-800 border-b pb-2">גיבוי וייצוא מלא (JSON)</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div>
                                     <button onclick="Settings.exportDataAsJSON()" class="w-full bg-indigo-600 text-white p-4 rounded-xl shadow hover:bg-indigo-700 flex items-center justify-center gap-2">
                                         <i class="fas fa-download"></i> הורד גיבוי מלא (JSON)
                                     </button>
                                     <p class="text-xs text-gray-500 mt-2">מוריד את כל הנתונים של המערכת לקובץ אחד.</p>
                                 </div>
                                 <div>
                                     <button onclick="document.getElementById('json-import-input').click()" class="w-full bg-white border-2 border-indigo-200 text-indigo-700 p-4 rounded-xl hover:bg-indigo-50 flex items-center justify-center gap-2">
                                         <i class="fas fa-upload"></i> שחזר / ייבא מגיבוי (JSON)
                                     </button>
                                     <p class="text-xs text-gray-500 mt-2 text-red-500 font-bold"><i class="fas fa-exclamation-triangle"></i> הפעולה לא דורסת נתונים קיימים, אלא מוסיפה רק חוסרים.</p>
                                 </div>
                             </div>
                        </div>

                        <div class="bg-white p-8 rounded-2xl shadow-sm border">
                            <h3 class="font-bold text-xl mb-6 text-slate-700 border-b pb-2">ניהול שדות מידע</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label class="block text-sm font-bold mb-2">בחר סוג רשימה:</label>
                                    <select id="settings-field-type" onchange="Settings.renderFieldsEditor()" class="input-field w-full mb-4">
                                        <option value="students">שדות בחור</option>
                                        <option value="donors">שדות תורם</option>
                                        <option value="finance">שדות כספים</option>
                                    </select>
                                    
                                    <div class="bg-gray-50 p-4 rounded-xl border">
                                        <div class="text-sm font-bold mb-2">הוסף שדה מהרשימה:</div>
                                        <div class="flex gap-2 mb-4">
                                            <select id="settings-predefined-field" class="input-field flex-1 text-sm"></select>
                                            <button onclick="Settings.addField()" class="btn-primary bg-indigo-600 text-sm px-4">הוסף</button>
                                        </div>
                                        
                                        <div class="border-t pt-4 mt-4">
                                             <div class="text-sm font-bold mb-2 text-indigo-700">+ צור שדה חדש לגמרי:</div>
                                             <div class="grid grid-cols-2 gap-2 mb-2">
                                                 <input type="text" id="custom-field-key" placeholder="מזהה (באנגלית)" class="input-field text-sm">
                                                 <input type="text" id="custom-field-label" placeholder="תווית (בעברית)" class="input-field text-sm">
                                             </div>
                                             <button onclick="Settings.addCustomField()" class="w-full bg-indigo-100 text-indigo-700 text-sm font-bold py-2 rounded hover:bg-indigo-200">צור והוסף שדה</button>
                                        </div>

                                        <div class="border-t pt-4 mt-4">
                                            <div class="text-sm font-bold mb-2 text-red-700">שדות מותאמים שנשמרו במערכת:</div>
                                            <div id="settings-custom-list" class="space-y-1"></div>
                                        </div>

                                        <div class="text-sm font-bold mt-4 mb-2">שדות פעילים:</div>
                                        <div id="settings-active-fields" class="space-y-2"></div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-500 bg-blue-50 p-4 rounded-xl">
                                    <h4 class="font-bold text-blue-800 mb-2"><i class="fas fa-info-circle"></i> מידע</h4>
                                    <p class="mb-2">שינוי שדות כאן ישפיע על:</p>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>טפסי הוספה/עריכה</li>
                                        <li>עמודות ביבוא ויצוא אקסל</li>
                                        <li>תצוגת הנתונים בטבלאות</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-purple-100 bg-purple-50/20">
                            <h3 class="font-bold text-xl mb-6 text-purple-800 border-b pb-2">ניהול תלושים ומענקים</h3>
                            <div id="settings-vouchers-list" class="space-y-3"></div>
                            <button onclick="Settings.addVoucherType()" class="btn-secondary text-purple-700 border-purple-200 hover:bg-purple-100 mt-3 text-sm font-bold">+ הוסף סוג תלוש חדש</button>
                        </div>
                        
                        <div class="bg-white p-8 rounded-2xl shadow-sm border">
                            <h3 class="font-bold text-xl mb-6 text-slate-700 border-b pb-2">יעדים ותמריצים כלליים</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="lbl">יעד גיוס כללי למערכת (ש"ח)</label>
                                    <input type="number" id="conf-global-goal" class="input-field w-full" onchange="Settings.save('globalGoal', this.value)">
                                </div>
                                <div class="bg-gray-50 p-4 rounded border">
                                    <label class="lbl mb-2">הנחת חבר קבוצה לפי זמן (ש"ח)</label>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2">
                                            <span class="w-16 text-sm">ליל י"ד:</span>
                                            <input type="number" id="conf-disc-night14" class="input-field w-full text-sm p-1" onchange="Settings.saveGroupDiscount('night14', this.value)">
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="w-16 text-sm">יום י"ד:</span>
                                            <input type="number" id="conf-disc-day14" class="input-field w-full text-sm p-1" onchange="Settings.saveGroupDiscount('day14', this.value)">
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="w-16 text-sm">יום ט"ו:</span>
                                            <input type="number" id="conf-disc-day15" class="input-field w-full text-sm p-1" onchange="Settings.saveGroupDiscount('day15', this.value)">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 border-t pt-4">
                                <h4 class="font-bold text-sm mb-3">בונוס אחוזים לתרומת תורם בודד (לפי מדרגות)</h4>
                                <div id="settings-bonus-tiers" class="space-y-2"></div>
                                <button onclick="Settings.addBonusTier()" class="text-indigo-600 text-sm font-bold mt-2 hover:underline">+ הוסף מדרגת טווח לתורם</button>
                            </div>

                            <div class="mt-6 border-t pt-4">
                                <h4 class="font-bold text-sm mb-3">בונוסים למביא תורם (סכום קבוע/מתנה)</h4>
                                <div id="settings-goals-tiers" class="space-y-2"></div>
                                <button onclick="Settings.addGoalTier()" class="text-indigo-600 text-sm font-bold mt-2 hover:underline">+ הוסף בונוס קבוע</button>
                            </div>
                        </div>

                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-amber-100 bg-amber-50/20">
                            <h3 class="font-bold text-xl mb-6 text-amber-800 border-b pb-2"><i class="fas fa-trophy mr-2"></i> יעדים ותגמולים לבחורים</h3>
                            <div class="mb-6">
                                <label class="lbl text-amber-900">יעד בסיס לכל בחור (מינימום)</label>
                                <input type="number" id="conf-base-student-goal" placeholder="לדוגמה: 2000" class="input-field w-full max-w-xs" onchange="Settings.save('baseStudentGoal', this.value)">
                            </div>

                            <div>
                                <h4 class="font-bold text-sm mb-3 text-amber-800">הגדרת מדרגות יעדים ומתנות</h4>
                                <div id="settings-student-rewards" class="space-y-3"></div>
                                <button onclick="Settings.addStudentReward()" class="btn-secondary text-amber-700 border-amber-200 hover:bg-amber-100 mt-3 text-sm font-bold">+ הוסף יעד תגמול</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- AI Chat Window -->
    <div id="ai-chat-window" class="hidden flex-col fixed bottom-24 left-8 w-80 h-96 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden z-[9999]">
        <!-- Header -->
        <div class="bg-slate-800 p-3 flex justify-between items-center text-white">
            <div class="flex items-center gap-2">
                <!-- Status Dot -->
                <div id="ai-status-dot" class="w-2.5 h-2.5 rounded-full bg-gray-400"></div>
                <span id="ai-status-text" class="text-xs font-bold">טוען עוזר...</span>
            </div>
            <button onclick="document.getElementById('ai-chat-window').classList.add('hidden')" class="hover:text-gray-300"><i class="fas fa-times"></i></button>
        </div>

        <!-- Messages Area -->
        <div id="ai-messages" class="flex-1 bg-slate-50 p-3 overflow-y-auto flex flex-col gap-2 custom-scroll text-sm"></div>

        <!-- File Preview -->
        <div id="ai-file-preview" class="hidden px-3 py-1 bg-gray-100 border-t flex justify-between items-center text-xs">
            <span id="ai-file-name" class="truncate max-w-[180px] text-gray-600 font-mono"></span>
            <button onclick="HybridAI.clearFile()" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
        </div>

        <!-- Input Area -->
        <div class="p-2 border-t bg-white flex items-center gap-2">
            <button onclick="document.getElementById('ai-file-input').click()" class="text-gray-400 hover:text-indigo-600 transition" title="צרף קובץ">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="ai-file-input" class="hidden" onchange="HybridAI.handleFileSelect(this)">
            
            <input type="text" id="ai-input" placeholder="הקלד הודעה..." class="flex-1 bg-gray-100 border-none rounded-full px-3 py-1.5 text-sm outline-none focus:ring-1 focus:ring-indigo-500" onkeypress="if(event.key === 'Enter') HybridAI.send()">
            
            <button onclick="HybridAI.send()" class="bg-indigo-600 hover:bg-indigo-700 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-sm transition">
                <i class="fas fa-arrow-up text-xs"></i>
            </button>
        </div>
    </div>

   <!-- AI FAB Button (בועה צפה לפתיחה) -->
<div id="ai-bubble-container" class="fixed bottom-6 left-6 z-[20000] hidden-screen">
    <button onclick="toggleChatWindow()" class="w-14 h-14 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full shadow-lg text-white flex items-center justify-center text-2xl hover:scale-110 transition duration-300 cursor-pointer">
        <i class="fas fa-robot"></i>
    </button>
</div>

<!-- הדבק את זה בסוף index.html לפני </body> -->
<script>
    // דריסה של הפונקציה הקיימת עם גרסה אלימה יותר
    window.toggleChatWindow = function() {
        console.log("מנסה לפתוח בכוח...");
        const w = document.getElementById('ai-chat-window');
        
        if (!w) {
            alert("שגיאה חמורה: האלמנט ai-chat-window לא נמצא ב-HTML!");
            return;
        }

        // בדיקה אם החלון מוסתר כרגע
        // אנחנו בודקים גם class וגם style ישיר
        const isHidden = w.classList.contains('hidden') || 
                         w.style.display === 'none' || 
                         getComputedStyle(w).display === 'none';

        if (isHidden) {
            // פעולות לפתיחה
            w.classList.remove('hidden');
            w.classList.add('flex'); // חשוב ל-Tailwind
            
            // שימוש ב-style ישיר כדי לעקוף כל CSS חיצוני
            w.style.display = 'flex !important'; 
            w.style.setProperty('display', 'flex', 'important');
            w.style.zIndex = '999999'; // שיהיה מעל הכל
            w.style.opacity = '1';
            w.style.visibility = 'visible';
            
            // פוקוס לשדה הטקסט
            setTimeout(() => {
                const input = document.getElementById('ai-input');
                if(input) input.focus();
            }, 100);
            
            console.log("החלון נפתח!");
        } else {
            // פעולות לסגירה
            w.classList.add('hidden');
            w.classList.remove('flex');
            w.style.display = 'none';
            w.style.setProperty('display', 'none', 'important');
            console.log("החלון נסגר.");
        }
    };
</script>
    <!-- Modal: Generic Form -->
    <div id="modal-form" class="fixed inset-0 z-50 bg-black/60 hidden-screen flex items-center justify-center backdrop-blur-sm transition-all duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-[550px] max-w-[90vw] overflow-hidden flex flex-col max-h-[90vh] scale-100 transition-transform">
            <div class="p-5 bg-gradient-to-r from-slate-800 to-slate-900 text-white flex justify-between items-center shrink-0">
                <h3 id="modal-title" class="font-bold text-xl tracking-wide">כותרת</h3>
                <button onclick="Modal.close()" class="hover:text-red-300 hover:rotate-90 transition transform"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="modal-body" class="p-8 overflow-y-auto space-y-5 custom-scroll"></div>
            <div class="p-5 bg-gray-50 flex gap-4 border-t shrink-0">
                <button id="modal-save-btn" class="flex-1 btn-primary py-3 text-lg shadow-md">שמור</button>
                <button onclick="Modal.close()" class="flex-1 btn-secondary py-3 text-lg">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Loading JS Files - Order Matters -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="store.js"></script>
    <script src="offline.js"></script>
    <script src="auth.js"></script>
    <script src="router.js"></script>
    <script src="students.js"></script>
    <script src="donors.js"></script>
    <script src="groups.js"></script>
    <script src="finance.js"></script>
    <script src="reports.js"></script>
    <script src="settings.js"></script>
    <script src="importer.js"></script>
    <script src="dashboard.js"></script>
    <script src="ai.js"></script> <!-- ה-AI נטען בסוף -->
    <script src="main.js"></script>

</body>

</html>

